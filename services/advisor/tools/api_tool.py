import asyncio
import json
import logging
import re
from typing import Dict, List, Any, Optional, Union, Tuple, Type
from urllib.parse import urlencode, urlparse

import httpx
from langchain.tools import BaseTool
from pydantic import BaseModel, Field, create_model, ValidationError

# Set up logging
logger = logging.getLogger(__name__)


class APIToolAutoScanner:
    """
    AUTOMATIC API Tool Scanner - HOÃ€N TOÃ€N Äá»˜NG!
    1. QuÃ©t app_config.json Ä‘á»ƒ tÃ¬m tools cÃ³ type = "api_tool"
    2. Tá»± Ä‘á»™ng táº¡o tools cho má»—i API
    3. KHÃ”NG HARD-CODE gÃ¬ cáº£ - táº¥t cáº£ tá»« config!
    """
    
    def __init__(self, config_path: str = "data/app_config.json"):
        self.config_path = config_path
        self.api_configs = self._scan_api_configs()
        logger.info(f"APIToolAutoScanner initialized with {len(self.api_configs)} API configurations")
    
    def _scan_api_configs(self) -> Dict[str, Dict[str, Any]]:
        """QuÃ©t tá»± Ä‘á»™ng táº¥t cáº£ API configurations tá»« app_config.json"""
        try:
            with open(self.config_path, 'r', encoding='utf-8') as f:
                config = json.load(f)
            
            tools = config.get("agent_config", {}).get("tools", [])
            api_configs = {}
            
            for tool in tools:
                # âœ… HOÃ€N TOÃ€N Äá»˜NG - Láº¤Y Tá»ª CONFIG!
                tool_type = tool.get("type", "")
                if tool_type == "api_tool":  # ÄÃšNG - Láº¤Y Tá»ª CONFIG!
                    api_name = tool.get("name", "unknown")
                    api_configs[api_name] = tool
                    logger.info(f"Found API tool config: {api_name} (type: {tool_type})")
                else:
                    logger.debug(f"Skipping tool {tool.get('name', 'unknown')} with type: {tool_type}")
            
            logger.info(f"Total API tools found: {len(api_configs)}")
            return api_configs
            
        except Exception as e:
            logger.error(f"Failed to scan API configs: {e}")
            return {}
    
    def create_all_api_tools(self) -> List['AutoGeneratedAPITool']:
        """Tá»± Ä‘á»™ng táº¡o tools cho Táº¤T Cáº¢ API Ä‘Ã£ phÃ¡t hiá»‡n"""
        tools = []
        
        for api_name, api_config in self.api_configs.items():
            try:
                tool = AutoGeneratedAPITool(api_config, self.config_path)
                tools.append(tool)
                logger.info(f"âœ… Auto-generated tool: {tool.name}")
            except Exception as e:
                logger.error(f"âŒ Failed to create tool for {api_name}: {e}")
        
        logger.info(f"ðŸŽ¯ Total auto-generated tools: {len(tools)}")
        return tools
    
    def create_specific_api_tool(self, api_name: str) -> Optional['AutoGeneratedAPITool']:
        """Táº¡o tool cho má»™t API cá»¥ thá»ƒ"""
        if api_name not in self.api_configs:
            logger.error(f"API '{api_name}' not found in scanned configs")
            return None
        
        try:
            return AutoGeneratedAPITool(self.api_configs[api_name], self.config_path)
        except Exception as e:
            logger.error(f"Failed to create tool for {api_name}: {e}")
            return None


class AutoGeneratedAPITool(BaseTool):
    """
    API Tool Ä‘Æ°á»£c táº¡o Tá»° Äá»˜NG HOÃ€N TOÃ€N tá»« config!
    KHÃ”NG HARD-CODE gÃ¬ cáº£ - táº¥t cáº£ tá»« app_config.json
    """
    
    def __init__(self, api_config: Dict[str, Any], config_path: str = "data/app_config.json"):
        # LÆ°u config Ä‘á»ƒ táº¡o Ä‘á»™ng
        self.api_config = api_config
        self.config_path = config_path
        
        # Tá»° Äá»˜NG Táº O táº¥t cáº£ properties
        self._auto_generate_all_properties()
        
        # Khá»Ÿi táº¡o HTTP client
        self.http_client = httpx.AsyncClient(timeout=30.0)
        
        # Gá»i constructor cha vá»›i properties Ä‘Æ°á»£c táº¡o Tá»° Äá»˜NG
        super().__init__(
            name=self._generate_tool_name(),
            description=self._generate_tool_description(),
            args_schema=self._generate_input_schema()
        )
        
        logger.info(f"ðŸš€ Auto-generated tool '{self.name}' ready for use!")
    
    def _auto_generate_all_properties(self):
        """Tá»° Äá»˜NG Táº O táº¥t cáº£ tool properties tá»« config"""
        # Láº¤Y Tá»ª CONFIG - KHÃ”NG HARD-CODE!
        self.api_name = self.api_config.get("name", "unknown_api")
        self.api_type = self.api_config.get("type", "api_tool")  # ÄÃšNG!
        self.api_description = self.api_config.get("description", "API endpoint")
        
        # Tá»± Ä‘á»™ng trÃ­ch xuáº¥t cáº¥u trÃºc input
        self.input_config = self.api_config.get("input", {})
        self.param_config = self.input_config.get("param", {})
        self.body_config = self.input_config.get("body", {})
        self.header_config = self.api_config.get("header", {})
        
        # Tá»± Ä‘á»™ng trÃ­ch xuáº¥t cáº¥u trÃºc output
        self.output_config = self.api_config.get("output", {})
        
        # Tá»± Ä‘á»™ng trÃ­ch xuáº¥t curl Ä‘á»ƒ láº¥y URL vÃ  method
        self.curl_command = self.api_config.get("curl", "")
    
    def _generate_tool_name(self) -> str:
        """Tá»± Ä‘á»™ng táº¡o tÃªn tool duy nháº¥t"""
        return f"api_{self.api_name}"
    
    def _generate_tool_description(self) -> str:
        """Tá»± Ä‘á»™ng táº¡o mÃ´ táº£ chi tiáº¿t tá»« config"""
        description_parts = []
        
        # MÃ´ táº£ cÆ¡ báº£n tá»« config
        description_parts.append(f"ðŸ”— {self.api_description}")
        
        # Tá»± Ä‘á»™ng Ä‘áº¿m parameters
        if self.param_config:
            param_count = len(self.param_config)
            description_parts.append(f"ðŸ“Š Query Parameters: {param_count}")
            
            # Tá»± Ä‘á»™ng liá»‡t kÃª key parameters
            key_params = list(self.param_config.keys())[:3]
            if key_params:
                description_parts.append(f"   Key params: {', '.join(key_params)}")
        
        # Tá»± Ä‘á»™ng Ä‘áº¿m body fields
        if self.body_config:
            body_count = len(self.body_config)
            description_parts.append(f" Body Fields: {body_count}")
            
            # Tá»± Ä‘á»™ng liá»‡t kÃª required fields
            required_fields = [name for name, config in self.body_config.items() 
                             if config.get("required", False)]
            if required_fields:
                description_parts.append(f"   Required: {', '.join(required_fields)}")
        
        # Tá»± Ä‘á»™ng detect HTTP method
        method = self._auto_detect_http_method()
        description_parts.append(f"ðŸŒ Method: {method}")
        
        # Tá»± Ä‘á»™ng táº¡o usage examples
        description_parts.append("\n Usage Examples:")
        
        # Táº¡o example cho query params
        if self.param_config:
            example_param = next(iter(self.param_config.keys()))
            example_value = self._auto_generate_example_value(self.param_config[example_param])
            description_parts.append(f"   Query: {example_param}={example_value}")
        
        # Táº¡o example cho body
        if self.body_config:
            example_body = next(iter(self.body_config.keys()))
            example_value = self._auto_generate_example_value(self.body_config[example_body])
            description_parts.append(f"   Body: {example_body}: {example_value}")
        
        return "\n".join(description_parts)
    
    def _auto_detect_http_method(self) -> str:
        """Tá»± Ä‘á»™ng detect HTTP method tá»« curl command"""
        curl = self.curl_command.lower()
        if "-x 'put'" in curl or "-x put" in curl:
            return "PUT"
        elif "-x 'post'" in curl or "-x post" in curl:
            return "POST"
        elif "-x 'get'" in curl or "-x get" in curl:
            return "GET"
        elif "-x 'delete'" in curl or "-x delete" in curl:
            return "DELETE"
        else:
            return "GET"
    
    def _generate_input_schema(self) -> Type[BaseModel]:
        """Tá»± Ä‘á»™ng táº¡o Pydantic input schema hoÃ n chá»‰nh"""
        
        fields = {
            "api_call_description": (
                str, 
                Field(
                    description=f"Describe what you want to do with {self.api_name}",
                    example=f"Use {self.api_name} to perform the requested operation"
                )
            )
        }
        
        # Tá»° Äá»˜NG Táº O query parameter fields
        if self.param_config:
            for param_name, param_def in self.param_config.items():
                field_type = self._auto_map_type(param_def.get("type", "string"))
                field_description = param_def.get("description", f"Parameter: {param_name}")
                field_default = param_def.get("default")
                field_required = param_def.get("required", False)
                
                # Tá»± Ä‘á»™ng táº¡o field vá»›i smart defaults
                if field_default is not None:
                    fields[f"param_{param_name}"] = (
                        field_type,
                        Field(
                            default=field_default,
                            description=field_description,
                            example=field_default
                        )
                    )
                else:
                    fields[f"param_{param_name}"] = (
                        field_type,
                        Field(
                            description=field_description,
                            example=self._auto_generate_example(param_def)
                        )
                    )
        
        # Tá»° Äá»˜NG Táº O body fields
        if self.body_config:
            for body_name, body_def in self.body_config.items():
                field_type = self._auto_map_type(body_def.get("type", "string"))
                field_description = body_def.get("description", f"Body field: {body_name}")
                field_required = body_def.get("required", False)
                
                if field_required:
                    fields[f"body_{body_name}"] = (
                        field_type,
                        Field(
                            description=field_description,
                            example=self._auto_generate_example(body_def)
                        )
                    )
                else:
                    fields[f"body_{body_name}"] = (
                        field_type,
                        Field(
                            default=None,
                            description=field_description,
                            example=self._auto_generate_example(body_def)
                        )
                    )
        
        # Tá»° Äá»˜NG Táº O header override fields
        if self.header_config:
            for header_name, header_value in self.header_config.items():
                if header_name.lower() not in ['content-type', 'accept']:
                    fields[f"header_{header_name}"] = (
                        str,
                        Field(
                            default=header_value,
                            description=f"Override {header_name} header",
                            example=header_value
                        )
                    )
        
        # Tá»± Ä‘á»™ng táº¡o model class
        model_name = f"{self.api_name.capitalize()}Input"
        return create_model(model_name, **fields)
    
    def _auto_map_type(self, config_type: str) -> Type:
        """Tá»± Ä‘á»™ng map config types sang Pydantic types"""
        type_mapping = {
            "string": str,
            "number": float,
            "integer": int,
            "boolean": bool,
            "array": List[str],
            "object": Dict[str, Any]
        }
        return type_mapping.get(config_type, str)
    
    def _auto_generate_example(self, field_def: Dict[str, Any]) -> Any:
        """Tá»± Ä‘á»™ng táº¡o smart examples dá»±a trÃªn field definition"""
        field_type = field_def.get("type", "string")
        field_name = field_def.get("name", "field")
        
        # Smart examples dá»±a trÃªn field name vÃ  type
        if "id" in field_name.lower():
            return "ID_001"
        elif "name" in field_name.lower():
            return "Example Name"
        elif "email" in field_name.lower():
            return "user@example.com"
        elif "phone" in field_name.lower():
            return "+1234567890"
        elif "price" in field_name.lower() or "cost" in field_name.lower():
            return 100.0
        elif "quantity" in field_name.lower() or "count" in field_name.lower():
            return 5
        elif "date" in field_name.lower() or "time" in field_name.lower():
            return "2024-01-15"
        elif field_type == "boolean":
            return True
        elif field_type == "number":
            return 100.0
        elif field_type == "integer":
            return 100
        elif field_type == "array":
            return ["item1", "item2"]
        elif field_type == "object":
            return {"key": "value"}
        else:
            return "example_value"
    
    def _auto_generate_example_value(self, field_def: Dict[str, Any]) -> Any:
        """Tá»± Ä‘á»™ng táº¡o example value cho field"""
        return self._auto_generate_example(field_def)
    
    def _auto_build_request(self, tool_input: Dict[str, Any]) -> Tuple[str, Dict[str, str], Optional[Dict[str, Any]]]:
        """Tá»± Ä‘á»™ng build HTTP request tá»« tool input"""
        
        # Tá»± Ä‘á»™ng trÃ­ch xuáº¥t URL tá»« curl
        url_match = re.search(r"'([^']+)'", self.curl_command)
        if not url_match:
            raise ValueError("Could not auto-extract URL from curl command")
        
        base_url = url_match.group(1)
        
        # Tá»± Ä‘á»™ng build query parameters
        query_params = {}
        for key, value in tool_input.items():
            if key.startswith("param_") and value is not None:
                param_name = key[6:]  # Remove "param_" prefix
                query_params[param_name] = value
        
        # Tá»± Ä‘á»™ng thÃªm query parameters vÃ o URL
        if query_params:
            query_string = urlencode(query_params)
            separator = '&' if '?' in base_url else '?'
            base_url = f"{base_url}{separator}{query_string}"
        
        # Tá»± Ä‘á»™ng build headers
        headers = {}
        headers.update(self.header_config)  # Start with defaults
        
        # Tá»± Ä‘á»™ng override vá»›i tool input
        for key, value in tool_input.items():
            if key.startswith("header_") and value is not None:
                header_name = key[7:]  # Remove "header_" prefix
                headers[header_name] = value
        
        # Tá»± Ä‘á»™ng build body
        body = None
        body_fields = {}
        for key, value in tool_input.items():
            if key.startswith("body_") and value is not None:
                body_name = key[5:]  # Remove "body_" prefix
                body_fields[body_name] = value
        
        if body_fields:
            body = body_fields
        
        return base_url, headers, body
    
    async def _auto_execute_api_call(self, url: str, headers: Dict[str, str], body: Optional[Dict[str, Any]] = None) -> Dict[str, Any]:
        """Tá»± Ä‘á»™ng execute HTTP request vá»›i detected method"""
        method = self._auto_detect_http_method()
        
        try:
            if method == "GET":
                response = await self.http_client.get(url, headers=headers)
            elif method == "POST":
                response = await self.http_client.post(url, headers=headers, json=body)
            elif method == "PUT":
                response = await self.http_client.put(url, headers=headers, json=body)
            elif method == "DELETE":
                response = await self.http_client.delete(url, headers=headers)
            else:
                raise ValueError(f"Unsupported HTTP method: {method}")
            
            response.raise_for_status()
            
            # Tá»± Ä‘á»™ng parse response
            try:
                response_data = response.json()
            except:
                response_data = response.text
            
            return {
                "success": True,
                "status_code": response.status_code,
                "method": method,
                "url": url,
                "data": response_data,
                "headers": dict(response.headers)
            }
            
        except httpx.HTTPStatusError as e:
            return {
                "success": False,
                "status_code": e.response.status_code,
                "method": method,
                "url": url,
                "error": f"HTTP {e.response.status_code}: {e.response.text}"
            }
        except Exception as e:
            return {
                "success": False,
                "method": method,
                "url": url,
                "error": str(e)
            }
    
    def _auto_format_response(self, response: Dict[str, Any]) -> str:
        """Tá»± Ä‘á»™ng format API response"""
        if not response.get("success"):
            return f"âŒ API call failed: {response.get('error', 'Unknown error')}"
        
        # Tá»± Ä‘á»™ng format successful response
        output = [
            f"âœ… {self.api_name} API call successful!",
            f"ðŸŒ Method: {response.get('method', 'N/A')}",
            f"ðŸ“¡ Status: {response.get('status_code', 'N/A')}",
            f" URL: {response.get('url', 'N/A')}",
            "",
            "ðŸ“Š Response Data:"
        ]
        
        data = response.get("data", {})
        if isinstance(data, dict):
            for key, value in data.items():
                if isinstance(value, (dict, list)):
                    output.append(f"  {key}: {json.dumps(value, indent=2, ensure_ascii=False)}")
                else:
                    output.append(f"  {key}: {value}")
        else:
            output.append(f"  {data}")
        
        return "\n".join(output)
    
    async def _arun(self, **kwargs) -> str:
        """Tá»± Ä‘á»™ng execute API call"""
        try:
            # Tá»± Ä‘á»™ng build request
            url, headers, body = self._auto_build_request(kwargs)
            
            # Tá»± Ä‘á»™ng execute API call
            response = await self._auto_execute_api_call(url, headers, body)
            
            # Tá»± Ä‘á»™ng format response
            return self._auto_format_response(response)
            
        except Exception as e:
            logger.error(f"Auto-generated API tool execution failed: {e}")
            return f"âŒ {self.api_name} API tool execution failed: {str(e)}"
    
    def _run(self, **kwargs) -> str:
        """Synchronous wrapper"""
        return asyncio.run(self._arun(**kwargs))
    
    async def __aenter__(self):
        return self
    
    async def __aexit__(self, exc_type, exc_val, exc_tb):
        await self.http_client.aclose()
    
    def __del__(self):
        """Tá»± Ä‘á»™ng cleanup"""
        try:
            asyncio.create_task(self.http_client.aclose())
        except:
            pass


# Convenience functions cho dá»… tÃ­ch há»£p
def create_auto_api_tools(config_path: str = "data/app_config.json") -> List[AutoGeneratedAPITool]:
    """Táº¡o táº¥t cáº£ auto-generated API tools"""
    scanner = APIToolAutoScanner(config_path)
    return scanner.create_all_api_tools()


def create_auto_api_tool(api_name: str, config_path: str = "data/app_config.json") -> Optional[AutoGeneratedAPITool]:
    """Táº¡o má»™t auto-generated API tool cá»¥ thá»ƒ"""
    scanner = APIToolAutoScanner(config_path)
    return scanner.create_specific_api_tool(api_name)


# Example usage vÃ  testing
if __name__ == "__main__":
    async def test_auto_generation():
        """Test há»‡ thá»‘ng auto-generation"""
        
        print("ðŸš€ Testing APIToolAutoScanner...")
        
        # Táº¡o táº¥t cáº£ tools tá»± Ä‘á»™ng
        all_tools = create_auto_api_tools()
        print(f"âœ… Auto-generated {len(all_tools)} tools:")
        
        for tool in all_tools:
            print(f"\nðŸ”§ Tool: {tool.name}")
            print(f" Description: {tool.description[:150]}...")
            print(f"ðŸ“Š Input Schema: {tool.args_schema.__name__}")
            
            # Show auto-generated input fields
            if hasattr(tool.args_schema, '__fields__'):
                print("ðŸ“‹ Auto-generated Input Fields:")
                for field_name, field_info in tool.args_schema.__fields__.items():
                    print(f"  - {field_name}: {field_info.type_} (default: {field_info.default})")
        
        # Test specific tool
        if all_tools:
            test_tool = all_tools[0]
            print(f"\n Testing first tool: {test_tool.name}")
            print(f"Name: {test_tool.name}")
            print(f"Description: {test_tool.description[:200]}...")
    
    # Run test
    asyncio.run(test_auto_generation()) 